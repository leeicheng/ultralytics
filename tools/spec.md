# 羽球場標註工具 – 規格書 v2.0

版本：2.0

日期：2025‑06‑17

---

## 1. 目的（Purpose）

提供跨平台且友善的圖形化介面（GUI），協助使用者於靜態影像或影片逐格快速標註羽球場關鍵點座標，並能批次管理、匯出多種格式，以支援電腦視覺與機器學習相關研究或商業應用。

## 2. 範圍（Scope）

- 支援 PNG / JPG 單張圖片以及 MP4 / AVI 影片逐格標註。
- 主要針對羽球場四點 Homography 轉換與 30 個標準點自動生成，但設計為可擴充至其他場地模板（籃球、網球等）。
- 適用 Windows / macOS / Linux；依賴 Python ≥ 3.11 及 Qt ≥ 6.6。

## 3. 名詞定義（Definitions）

| 名稱 | 說明 |
| --- | --- |
| **直角點 (Corner, type 0)** | 羽球場邊框或場角落折角點 |
| **T 字點 (T‑junction, type 1)** | 邊線與底線相交形成 T 字之端點 |
| **十字點 (Cross, type 2)** | 兩條線垂直相交形成十字點 |
| **Template** | 以局部座標（0–1）定義的標準場地點集合 |
| **Project 檔** | 儲存使用者工作進度的 .json 或 .yaml 檔 |

## 4. 系統概觀（System Overview）

- 主視窗分為：影像檢視區、點列表面板、工具列 / 狀態列。
- 支援多張影像的索引側欄與搜尋過濾。
- 使用者可在一般模式與 Homography 模式間切換。

## 5. 功能需求（Functional Requirements）

### 5.1 影像載入與切換

1. **載入資料夾**：一次讀取資料夾內所有圖片／影片，依檔名排序。
2. **顯示模式**：
    - *單一（Selected）*：僅顯示當前項目。
    - *縮圖（Gallery）*：格狀檢視全部縮圖，點擊可開啟。
3. **鍵盤瀏覽**：`↑` / `↓` 或 `PgUp` / `PgDn` 切換上一張 / 下一張。

### 5.2 圖像檢視操作

| 操作 | 滑鼠 / 鍵盤 | 說明 |
| --- | --- | --- |
| 放大 / 縮小 | 滾輪 | 以游標為中心縮放（1.1× / 0.9×）。 |
| 平移 | 按空白鍵拖曳或中鍵拖曳 | 平移畫布。 |
| 100% / 適合畫面 | `1` / `2` | 重設縮放比例。 |

### 5.3 點標註

1. **新增**：左鍵單擊新增 *直角點*；新增後即為選取狀態。
2. **編輯選單**（右鍵）
    - 變更類型 → 直角 / T 字 / 十字。
    - 刪除點。
3. **拖曳**：選取後可拖曳移動座標。
4. **快捷鍵**
    
    
    | 功能 | 快捷鍵 |
    | --- | --- |
    | 切換類型 0/1/2 | `1` / `2` / `3` |
    | 刪除點 | `Del` |
    | Undo / Redo | `Ctrl+Z` / `Ctrl+Y` |
    | 儲存 | `Ctrl+S` |

### 5.4 Homography 模式

1. 進入後引導依序點擊：左下 → 右下 → 右上 → 左上 (4 點)。
2. 4 點完成即自動計算單應性矩陣並：
    - 在 overlay 顯示對應球場網格供視覺驗證。
    - 產生 30 個標準羽球場點並切回一般模式。
3. **模板管理**：
    - 內建 `TEMPLATE_POINTS`（羽球 30 點）。

### 5.5 點管理面板

- 以表格列出：ID、X、Y、類型、所屬影像影格。
- 功能：點擊跳轉 / 選取、多選批次刪除、排序、篩選、複製座標。

### 5.6 檔案與專案

1. **專案檔**：以 `.json` 或 `.yaml` 儲存每張影像（或影片影格）的點資料、縮放 / 平移狀態與偏好設定。
2. **自動存檔**：每 30 秒或工作狀態改變 5 秒後自動保存（以 debounce 實作）。
3. **批次匯出**：
    - 單一影像 → 同名 `.csv` / `.json` / `.txt`。
    - 整個資料夾 → 壓縮 zip 內含所有輸出檔及 `summary.csv`。
    - 支援格式：CSV、COCO JSON、YOLO Darknet (`class x_center y_center width height`)。

### 5.7 智慧輔助（選配模組）

- **自動偵測初始 4 點**：結合 Canny + Hough line + 球場幾何規則。
- **吸附（Snap）**：游標接近線段時自動對齊，其閾值可自訂（pixel / 相對百分比）。

### 5.8 影片 / 連續影格支援

- 影片開啟後顯示時間軸，可逐格或跳格 (`←`/`→`)。
- 提供「複製上一影格座標」功能，減少重複標註。

## 7. 例外與錯誤處理

- GUI 底部狀態列即時顯示錯誤訊息並提供「複製堆疊」按鈕。
- 儲存失敗時自動備份為 `.backup` 並提示使用者。

## 8. 使用者體驗（UX）
- 新增放大鏡功能：在ImageViewer上新增一個固定的大小的區域，可以將游標周圍的畫面放大顯示在這裡
  - 滑鼠滾輪事件改為更改放大鏡功能的倍率。
  - 放大鏡中間要有一個1pixel 的紅點當成準心

```python
TEMPLATE_POINTS: np.ndarray = np.array([
    # Row 1 – far baseline (y = 13.40 m) → 01-05
    [0.00, 13.40,"Corner"],  # 01 outer-left
    [0.46, 13.40,"T"],  # 02 left singles side
    [3.05, 13.40,"T"],  # 03 centre line
    [5.64, 13.40,"T"],  # 04 right singles side
    [6.10, 13.40,"Corner"],  # 05 outer-right
    # Row 2 – far doubles long service (y = 12.64 m) → 06-10
    [0.00, 12.64,"T"],  # 06
    [0.46, 12.64,"Cross"],  # 07
    [3.05, 12.64,"Cross"],  # 08
    [5.64, 12.64,"Cross"],  # 09
    [6.10, 12.64,"T"],  # 10
    # Row 3 – far short service (y = 8.68 m) → 11-15
    [0.00, 8.68,"T"],   # 11
    [0.46, 8.68,"Cross"],   # 12
    [3.05, 8.68,"T"],   # 13
    [5.64, 8.68,"Cross"],   # 14
    [6.10, 8.68,"T"],   # 15
    # Row 5 – near short service (y = 4.72 m) → 18-22
    [0.00, 4.72,"T"],   # 18
    [0.46, 4.72,"Cross"],   # 19
    [3.05, 4.72,"T"],   # 20
    [5.64, 4.72,"Cross"],   # 21
    [6.10, 4.72,"T"],   # 22
    # Row 6 – near doubles long service (y = 0.76 m) → 23-27
    [0.00, 0.76,"T"],   # 23
    [0.46, 0.76,"Cross"],   # 24
    [3.05, 0.76,"Cross"],   # 25
    [5.64, 0.76,"Cross"],   # 26
    [6.10, 0.76,"T"],   # 27
    # Row 7 – near baseline (y = 0.00 m) → 28-32
    [0.00, 0.00,"Corner"],   # 28
    [0.46, 0.00,"T"],   # 29
    [3.05, 0.00,"T"],   # 30
    [5.64, 0.00,"T"],   # 31
    [6.10, 0.00,"Corner"],   # 32
], dtype=np.float32)

assert TEMPLATE_POINTS.shape == (30, 2)
```