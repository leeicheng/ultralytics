# **羽球場交點標記工具規格書**
## **目錄**
1. [工具功能規格](#工具功能規格)
2. [標記準則](#標記準則)
3. [輸出格式規範](#輸出格式規範)
4. [用戶介面設計](#用戶介面設計)
5. [品質控制機制](#品質控制機制)
6. [實作建議](#實作建議)

---

## **工具功能規格**

### **1. 核心功能需求**

#### **1.1 基本標記功能**
- **點擊標記**: 滑鼠點擊影像上的交點位置進行標記
- **類別選擇**: 支援三種交點類別的快速切換
- **精確定位**: 支援亞像素級的精確定位（建議縮放功能）
- **標記編輯**: 支援標記點的移動、刪除和類別修改
- **批量操作**: 支援批量刪除、批量類別變更

#### **1.2 視覺輔助功能**
- **縮放與平移**: 支援滑鼠滾輪縮放和拖拽平移
- **十字線輔助**: 在滑鼠游標處顯示十字線，輔助精確定位
- **網格覆蓋**: 可選的網格覆蓋，幫助識別線條結構
- **對比度調整**: 實時調整影像對比度和亮度，提高線條可見度
- **標記點高亮**: 不同類別的標記點使用不同顏色和形狀

#### **1.3 效率優化功能**
- **鍵盤快捷鍵**: 支援數字鍵1-3快速切換類別
- **進度追蹤**: 顯示當前標記進度和剩餘工作量
- **標記統計**: 實時顯示各類別標記數量
- **復原/重做**: 支援多步驟的復原和重做操作

### **2. 檔案管理功能**

#### **2.1 專案管理**
- **專案建立**: 建立新的標記專案，設定工作資料夾
- **影像匯入**: 批量匯入支援的影像格式（JPG, PNG, TIFF等）
- **進度儲存**: 保存標記進度，支援中斷後繼續工作
- **備份機制**: 定期備份標記資料，防止資料遺失

#### **2.2 資料匯出**
- **YOLO格式匯出**: 輸出符合YOLO訓練格式的標籤檔案
- **批量匯出**: 一鍵匯出所有已標記影像的標籤檔案

---

## **標記準則**

### **1. 交點類別定義**

#### **1.1 T字交點 (類別0)**
**定義**: 三條線交匯形成的T字形交點

**識別特徵**:
- 正好有三條線在一點匯聚
- 形成類似字母"T"的結構
- 一條主線被一條垂直線分割

**標記位置**: 三條線的幾何中心點

**常見位置**:
- 羽球場邊線與中線的交點
- 邊線與服務線的交點
- 雙打邊線與單打邊線的交點

**標記示例**:
```
     |
     |
-----+-----  ← 標記此點
     
```

#### **1.2 十字交點 (類別1)**
**定義**: 四條線交匯形成的十字形交點

**識別特徵**:
- 正好有四條線在一點匯聚
- 形成類似"+"或"×"的結構
- 兩條線相互垂直或斜交

**標記位置**: 四條線的幾何中心點

**常見位置**:
- 中線與中央服務線的交點
- 中線與前服務線的交點
- 場地中央的主要交點

**標記示例**:
```
     |
     |
-----+-----  ← 標記此點
     |
     |
```

#### **1.3 L角交點 (類別2)**
**定義**: 兩條線交匯形成的L型或直角交點

**識別特徵**:
- 正好有兩條線在一點匯聚
- 形成類似字母"L"的直角結構
- 通常出現在場地角落或邊界

**標記位置**: 兩條線的交點

**常見位置**:
- 場地四個角落
- 邊線的轉角處
- 服務區的角落

**標記示例**:
```
-----+
     |
     |  ← 標記交點
     |
```

### **2. 標記精度要求**

#### **2.1 位置精度**
- **像素精度**: 標記誤差應控制在 ±2 像素以內
- **一致性**: 同類型交點的標記位置應保持一致
- **重複性**: 同一標記者對同一交點的重複標記應在 ±1 像素以內

#### **2.2 完整性要求**
- **覆蓋度**: 每張影像中所有可見的交點都必須標記
- **類別完整**: 三種類別的交點都應有適當的標記數量
- **邊界處理**: 部分可見的交點也需要標記

### **3. 標記品質標準**

#### **3.1 視覺清晰度**
- **最小可見度**: 交點必須在原始解析度下清晰可見
- **模糊處理**: 運動模糊或焦點模糊的交點可以標記，但需要額外註記
- **遮擋處理**: 被球員或其他物體部分遮擋的交點，如果位置可以推斷則應標記

#### **3.2 幾何正確性**
- **線條連續性**: 確保標記的交點確實是線條的真實交匯點
- **透視修正**: 考慮攝影機角度造成的透視變形
- **陰影區分**: 區分真實線條和陰影造成的假線條

### **4. 特殊情況處理**

#### **4.1 模糊交點**
- **標準**: 如果交點位置可以合理推斷（誤差<5像素），則進行標記
- **處理**: 使用周圍清晰線條的延伸來推斷交點位置
- **標註**: 在備註中標明為"推斷位置"

#### **4.2 重疊線條**
- **標準**: 多條線條在同一位置重疊時，按照最主要的線條結構進行分類
- **處理**: 優先識別場地邊界線形成的交點
- **標註**: 記錄重疊線條的數量和類型

#### **4.3 破損線條**
- **標準**: 線條因磨損或維護而不連續時，仍按照完整線條處理
- **處理**: 連接破損處，推斷完整的線條走向
- **標註**: 標記為"破損線條"

#### **4.4 非標準交點**
- **Y型交點**: 三條線以Y型匯聚，歸類為T字交點
- **多線交點**: 超過四條線匯聚，選擇最主要的四條線，歸類為十字交點
- **銳角交點**: 兩條線形成銳角（<60°），仍歸類為L角交點

---

## **輸出格式規範**

### **1. 檔案結構**

```
project_root/
├── images/
│   ├── train/
│   │   ├── court_001.jpg
│   │   ├── court_002.jpg
│   │   └── ...
│   ├── val/
│   │   ├── court_101.jpg
│   │   ├── court_102.jpg
│   │   └── ...
│   └── test/
│       ├── court_201.jpg
│       └── ...
├── labels/
│   ├── train/
│   │   ├── court_001.txt
│   │   ├── court_002.txt
│   │   └── ...
│   ├── val/
│   │   ├── court_101.txt
│   │   ├── court_102.txt
│   │   └── ...
│   └── test/
│       ├── court_201.txt
│       └── ...
└── metadata/
    ├── annotation_stats.json
    ├── quality_report.json
    └── project_config.yaml
```

### **2. YOLO標籤格式**

#### **2.1 單行格式**
```
<class_id> <x_center> <y_center> <width> <height> <kpt_x> <kpt_y> <kpt_visibility>
```

#### **2.2 欄位說明**
| 欄位 | 型別 | 範圍 | 說明 |
|------|------|------|------|
| class_id | int | 0-2 | 交點類別 (0:T字, 1:十字, 2:L角) |
| x_center | float | 0.0-1.0 | 佔位符邊界框中心x座標 (正規化) |
| y_center | float | 0.0-1.0 | 佔位符邊界框中心y座標 (正規化) |
| width | float | 固定值 | 佔位符邊界框寬度 (建議0.01) |
| height | float | 固定值 | 佔位符邊界框高度 (建議0.01) |
| kpt_x | float | 0.0-1.0 | 關鍵點x座標 (正規化) |
| kpt_y | float | 0.0-1.0 | 關鍵點y座標 (正規化) |
| kpt_visibility | int | 固定值2 | 關鍵點可見性 (2=可見且已標記) |

#### **2.3 座標轉換**
```python
# 像素座標轉正規化座標
normalized_x = pixel_x / image_width
normalized_y = pixel_y / image_height

# 佔位符邊界框設定
x_center = kpt_x  # 與關鍵點位置相同
y_center = kpt_y  # 與關鍵點位置相同
width = 0.01      # 固定小值
height = 0.01     # 固定小值
```

#### **2.4 輸出範例**

**影像: court_001.jpg (1920x1080)**
```
# court_001.txt
0 0.4531 0.6713 0.01 0.01 0.4531 0.6713 2
1 0.2344 0.4563 0.01 0.01 0.2344 0.4563 2
2 0.7891 0.1234 0.01 0.01 0.7891 0.1234 2
1 0.5670 0.8901 0.01 0.01 0.5670 0.8901 2
```
---



#### **3.3 視覺反饋**
- **游標十字線**: 在游標位置顯示十字線輔助定位
- **標記點樣式**: 不同類別使用不同顏色和符號
  - T字交點: 紅色圓形 ● (半徑5px)
  - 十字交點: 藍色方形 ■ (邊長8px)
  - L角交點: 綠色三角形 ▲ (邊長8px)
- **選中狀態**: 選中的標記點顯示黃色外框
- **懸停效果**: 滑鼠懸停時顯示標記資訊提示

### **4. 對話框設計**


#### **4.2 匯出設定對話框**
```
┌─匯出標記資料──────────────────────┐
│ 匯出格式: ● YOLO ○ COCO ○ CSV     │
│ 輸出目錄: [________________] [瀏覽] │
│                                   │
│ 資料分割:                         │
│ 訓練集: [70]% 驗證集: [20]% 測試集: [10]% │
│ □ 隨機分割 ● 依檔名排序           │
│                                   │
│ 標記選項:                         │
│ □ 僅匯出已審核的標記              │
│ □ 包含統計報告                    │
│ □ 包含品質報告                    │
│                                   │
│         [匯出] [取消]             │
└───────────────────────────────────┘
```


## **實作建議**

### **1. 技術架構**


#### **1.2 核心類別設計**
```python
class Annotation:
    """單個標記點的資料結構"""
    def __init__(self, x, y, class_id, image_id):
        self.id = generate_id()
        self.pixel_x = x
        self.pixel_y = y
        self.class_id = class_id
        self.image_id = image_id
        self.timestamp = datetime.now()
        self.annotator = get_current_user()
        self.reviewed = False
        self.notes = ""
    
    def to_yolo_format(self, image_width, image_height):
        """轉換為YOLO格式"""
        normalized_x = self.pixel_x / image_width
        normalized_y = self.pixel_y / image_height
        return f"{self.class_id} {normalized_x:.6f} {normalized_y:.6f} 0.01 0.01 {normalized_x:.6f} {normalized_y:.6f} 2"

class AnnotationProject:
    """標記專案管理"""
    def __init__(self, project_path):
        self.project_path = project_path
        self.config = self.load_config()
        self.images = self.load_images()
        self.annotations = self.load_annotations()
    
    def export_yolo_format(self, output_path):
        """匯出YOLO格式資料"""
        pass
```
